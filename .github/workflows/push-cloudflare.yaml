name: Build and Deploy to Cloudflare

on:
    push:
        branches: [main, uat, release*]
    pull_request_target:
        branches: [main, uat, release*]
    workflow_dispatch:

jobs:
    deploy:
        name: Deploy to Cloudflare
        runs-on: ubuntu-latest
        # 避免并发部署导致冲突
        concurrency:
            group: ${{ github.workflow }}-${{ github.ref }}
            cancel-in-progress: true

        steps:
            - uses: actions/checkout@v4

            # 安装 Rust 工具链
            - run: rustup toolchain install stable --profile minimal
            - run: rustup target add wasm32-unknown-unknown
            
            - name: Install lld
              run: sudo apt install -y lld clang gcc llvm

            # 清理 Cargo 缓存，确保全新构建
            - name: Clean Cargo cache
              run: cargo clean

            # 安装 worker-build (强制重新安装)
            - name: Install worker-build
              run: |
                  cargo install worker-build --force

            # 替换数据库 ID
            - name: Replace D1_DATABASE_ID in wrangler.jsonc
              run: |
                  sed -i 's/"database_id": "[^"]*"/"database_id": "${{ secrets.D1_DATABASE_ID }}"/g' wrangler.jsonc
            
            # 部署 (Wrangler 会自动读取配置并执行 worker-build --release)
            - uses: cloudflare/wrangler-action@v3
              id: cf
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                  wranglerVersion: "4.65.0"